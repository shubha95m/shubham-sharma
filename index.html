<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Builder | Select Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Grotesk:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f172a;
            --text-light: #f8fafc;
            --accent: #3b82f6;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 3rem;
            margin-bottom: 0.5rem;
            text-align: center;
            background: linear-gradient(to right, #60a5fa, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            color: #94a3b8;
            font-size: 1.2rem;
            margin-bottom: 4rem;
            text-align: center;
        }

        .profiles-grid {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1200px;
            padding: 0 2rem;
        }

        .profile-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2.5rem;
            width: 300px;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-light);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .profile-card:hover {
            transform: translateY(-10px);
            border-color: var(--accent);
            box-shadow: 0 20px 40px -10px rgba(59, 130, 246, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .profile-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
            transition: 0.3s;
        }

        .profile-card:hover .profile-img {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .profile-name {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            font-weight: 700;
        }

        .profile-title {
            color: #94a3b8;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.5;
        }

        .view-btn {
            margin-top: 1.5rem;
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.3s;
        }

        .profile-card:hover .view-btn {
            background: var(--accent);
            color: white;
        }

        .loading {
            font-size: 1.2rem;
            color: #94a3b8;
        }
    </style>
</head>

<body>

    <div>
        <h1>Select Profile</h1>
        <p class="subtitle">Choose a candidate to view their interactive resume</p>
    </div>

    <div id="profiles" class="profiles-grid">
        <div class="loading">Loading profiles...</div>
    </div>

    <!-- Import Logic -->
    <div style="text-align:center; margin-top:3rem;">
        <p style="color:#94a3b8; margin-bottom:1rem;">Or create a new profile</p>
        <div style="display:flex; justify-content:center; gap:1rem; flex-wrap:wrap;">
            <button onclick="document.getElementById('file-upload').click()"
                style="background:#a855f7; color:white; border:none; padding:1rem 2rem; border-radius:50px; font-size:1rem; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-cloud-upload-alt"></i> Import PDF / Text Resume
            </button>
            <button onclick="openCVBuilder()"
                style="background:#3b82f6; color:white; border:none; padding:1rem 2rem; border-radius:50px; font-size:1rem; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-comments"></i> Build CV from Scratch
            </button>
        </div>
        <input type="file" id="file-upload" accept=".pdf,.txt" style="display:none;" onchange="handleFileUpload(this)">
        <p id="upload-status" style="margin-top:1rem; color:#cbd5e1; font-size:0.9rem; min-height:1.2em;"></p>
    </div>

    <!-- Custom Delete Modal -->
    <div id="delete-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); z-index:1000; justify-content:center; align-items:center;">
        <div
            style="background:#1e293b; padding:2rem; border-radius:15px; width:400px; text-align:center; border:1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
            <div
                style="width:60px; height:60px; background:rgba(239, 68, 68, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem auto;">
                <i class="fas fa-trash-alt" style="font-size:1.5rem; color:#ef4444;"></i>
            </div>
            <h3 style="margin:0 0 0.5rem 0; font-family:'Space Grotesk'; font-size:1.5rem;">Delete Profile?</h3>
            <p style="color:#94a3b8; margin-bottom:2rem; line-height:1.5;">
                Are you sure you want to delete the profile for <br><strong style="color:white;"
                    id="modal-username">User</strong>?
                <br><br>
                <span style="font-size:0.9rem; color:#ef4444;">This action cannot be undone. All resume data will be
                    permanently lost.</span>
            </p>
            <div style="display:flex; justify-content:center; gap:1rem;">
                <button onclick="closeDeleteModal()"
                    style="padding:0.8rem 1.5rem; border-radius:50px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:white; cursor:pointer; font-weight:600; transition:0.2s;">Cancel</button>
                <button onclick="confirmDelete()"
                    style="padding:0.8rem 1.5rem; border-radius:50px; border:none; background:#ef4444; color:white; cursor:pointer; font-weight:600; box-shadow:0 4px 6px -1px rgba(239, 68, 68, 0.3); transition:0.2s;">Delete
                    Forever</button>
            </div>
        </div>
    </div>

    <!-- CV Builder Chat Modal -->
    <div id="cv-builder-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter:blur(5px); z-index:1000; justify-content:center; align-items:center;">
        <div
            style="background:#1e293b; padding:0; border-radius:15px; width:90%; max-width:800px; height:80vh; display:flex; flex-direction:column; border:1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">

            <!-- Header -->
            <div
                style="padding:1.5rem; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0; font-family:'Space Grotesk'; font-size:1.5rem; color:white;">
                        <i class="fas fa-robot" style="color:#3b82f6;"></i> CV Builder Assistant
                    </h3>
                    <p style="margin:0.5rem 0 0 0; font-size:0.85rem; color:#94a3b8;">Powered by Claude AI</p>
                </div>
                <button onclick="closeCVBuilder()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:0.2s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                    onmouseout="this.style.background='none'">&times;</button>
            </div>

            <!-- Progress Bar -->
            <div
                style="padding:1rem 1.5rem; background:rgba(0,0,0,0.2); border-bottom:1px solid rgba(255,255,255,0.1);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <span style="font-size:0.85rem; color:#94a3b8;" id="progress-text">Step 1 of 9</span>
                    <span style="font-size:0.85rem; color:#3b82f6; font-weight:600;" id="progress-percent">11%</span>
                </div>
                <div
                    style="width:100%; height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;">
                    <div id="progress-bar"
                        style="width:11%; height:100%; background:linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius:3px; transition:width 0.3s ease;">
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages"
                style="flex:1; overflow-y:auto; padding:1.5rem; display:flex; flex-direction:column; gap:1rem;">
                <!-- Messages will be added here -->
            </div>

            <!-- Input Area -->
            <div style="padding:1.5rem; border-top:1px solid rgba(255,255,255,0.1); background:rgba(0,0,0,0.2);">
                <div style="display:flex; gap:1rem; align-items:flex-end;">
                    <textarea id="chat-input" placeholder="Type your answer here..."
                        style="flex:1; background:#0f172a; border:1px solid #334155; color:white; padding:1rem; border-radius:8px; font-family:'Outfit'; resize:none; min-height:60px; max-height:120px;"
                        onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendMessage();}"></textarea>
                    <button onclick="sendMessage()"
                        style="background:#3b82f6; border:none; color:white; padding:1rem 2rem; border-radius:8px; font-weight:600; cursor:pointer; height:60px; display:flex; align-items:center; gap:0.5rem; transition:0.2s;"
                        onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
                <p id="chat-status" style="margin:0.5rem 0 0 0; font-size:0.8rem; color:#94a3b8; min-height:1em;"></p>
            </div>
        </div>
    </div>

    <script>
        let profileToDelete = null;

        async function loadProfiles() {
            try {
                const response = await fetch('cv-content/users.json');
                const users = await response.json();

                const container = document.getElementById('profiles');
                container.innerHTML = users.map(user => `
                    <div class="profile-card">
                        <img src="${user.avatar}" alt="${user.name}" class="profile-img">
                        <h2 class="profile-name">${user.name}</h2>
                        <p class="profile-title">${user.title}</p>
                        
                        <div style="display:flex; justify-content:center; gap:10px; margin-top:1.5rem;">
                            <a href="resume.html?user=${user.id}" class="view-btn" style="margin-top:0;">View <i class="fas fa-arrow-right"></i></a>
                            <button onclick="openDeleteModal('${user.id}', '${user.name}')" class="view-btn" style="margin-top:0; background:rgba(239, 68, 68, 0.1); color:#ef4444; border:none; cursor:pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                document.getElementById('profiles').innerHTML = `
                    <div style="color: #ef4444; text-align: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i><br>
                        Failed to load profiles.<br>
                        <small>${e.message}</small>
                    </div>
                `;
            }
        }

        function openDeleteModal(userId, userName) {
            profileToDelete = userId;
            document.getElementById('modal-username').textContent = userName;
            const modal = document.getElementById('delete-modal');
            modal.style.display = 'flex';
        }

        function closeDeleteModal() {
            profileToDelete = null;
            document.getElementById('delete-modal').style.display = 'none';
        }

        async function confirmDelete() {
            if (!profileToDelete) return;

            const modalBtn = document.querySelector('#delete-modal button:last-child');
            const originalText = modalBtn.textContent;
            modalBtn.textContent = 'Deleting...';
            modalBtn.disabled = true;

            try {
                const res = await fetch(`http://localhost:3000/api/delete/${profileToDelete}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    closeDeleteModal();
                    loadProfiles();
                } else {
                    alert('Failed to delete profile');
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting profile');
            } finally {
                modalBtn.textContent = originalText;
                modalBtn.disabled = false;
            }
        }

        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('upload-status');
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reading file and using AI to structure your data... (This may take ~15 seconds)';

            const formData = new FormData();
            formData.append('resumeFile', file);

            try {
                const res = await fetch('http://localhost:3000/api/import', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();

                if (data.success) {
                    status.innerHTML = '<i class="fas fa-check-circle" style="color:#22c55e;"></i> Success! Redirecting...';
                    setTimeout(() => {
                        window.location.href = `resume.html?user=${data.userId}`;
                    }, 1000);
                } else {
                    status.innerHTML = `<span style="color:#ef4444"><i class="fas fa-times-circle"></i> ${data.error}</span>`;
                }
            } catch (e) {
                status.innerHTML = `<span style="color:#ef4444"><i class="fas fa-times-circle"></i> Upload Failed: ${e.message}</span>`;
            }

            // Reset input
            input.value = '';
        }

        // --- CV BUILDER LOGIC ---
        let conversationHistory = [];
        let currentSection = 'start';
        let generatedCVData = null;

        // Section mapping for progress tracking
        const sectionOrder = ['start', 'email', 'location', 'phone', 'taglines', 'summary', 'experience', 'skills', 'education', 'highlights', 'complete'];

        // Example inputs for each section
        const sectionExamples = {
            'email': 'Example: john.doe@example.com',
            'location': 'Example: San Francisco, USA',
            'phone': 'Example: +1-555-0123',
            'taglines': 'Example: Senior Software Engineer, Full Stack Developer, Tech Lead',
            'summary': 'Example: I have 8 years of experience building scalable web applications. Led teams of 5+ engineers, increased system performance by 40%, and delivered features used by millions of users.',
            'experience': 'Example:\nSenior Software Engineer\nGoogle\nJan 2020 - Present\nBuilt recommendation engine that increased user engagement by 35%. Led team of 5 engineers. Reduced API latency from 200ms to 50ms.',
            'skills': 'Example: JavaScript, Python, React, Node.js, AWS, Docker, Kubernetes, PostgreSQL, Redis, CI/CD',
            'education': 'Example:\nB.S. Computer Science\nStanford University\n2016\n3.8 GPA',
            'highlights': 'Example: Built an AI-powered analytics platform that processes 10M+ events daily. Created automated testing framework that reduced QA time by 60%.'
        };

        function updateProgress() {
            const currentIndex = sectionOrder.indexOf(currentSection);
            const totalSteps = sectionOrder.length - 1; // Exclude 'complete'
            const percentage = Math.round((currentIndex / totalSteps) * 100);

            document.getElementById('progress-text').textContent = `Step ${currentIndex + 1} of ${totalSteps}`;
            document.getElementById('progress-percent').textContent = `${percentage}%`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;

            // Update placeholder with example
            const input = document.getElementById('chat-input');
            if (sectionExamples[currentSection]) {
                input.placeholder = sectionExamples[currentSection];
            } else {
                input.placeholder = 'Type your answer here...';
            }
        }

        function openCVBuilder() {
            document.getElementById('cv-builder-modal').style.display = 'flex';
            conversationHistory = [];
            currentSection = 'start';
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-input').value = '';

            // Start conversation
            initiateCVBuilder();
        }

        function closeCVBuilder() {
            document.getElementById('cv-builder-modal').style.display = 'none';
        }

        async function initiateCVBuilder() {
            try {
                console.log('[CV BUILDER] Initiating conversation...');
                const res = await fetch('http://localhost:3000/api/ai/build-cv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversationHistory: [],
                        userMessage: null,
                        currentSection: 'start'
                    })
                });

                console.log('[CV BUILDER] Response status:', res.status);

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Server error');
                }

                const data = await res.json();
                console.log('[CV BUILDER] Response data:', data);

                if (data.message) {
                    addMessage('ai', data.message);
                    currentSection = data.section;
                    updateProgress();
                } else if (data.error) {
                    addMessage('ai', 'Error: ' + data.error);
                }
            } catch (e) {
                console.error('[CV BUILDER] Error:', e);
                addMessage('ai', 'Sorry, there was an error starting the conversation. Please try again.\n\nError: ' + e.message);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to UI
            addMessage('user', message);
            input.value = '';

            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });

            // Show loading
            const status = document.getElementById('chat-status');
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Claude is thinking...';

            try {
                const res = await fetch('http://localhost:3000/api/ai/build-cv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversationHistory: conversationHistory,
                        userMessage: message,
                        currentSection: currentSection
                    })
                });

                const data = await res.json();
                status.innerHTML = '';

                if (data.message) {
                    addMessage('ai', data.message);
                    conversationHistory.push({ role: 'assistant', content: data.message });
                    currentSection = data.section;
                    updateProgress();
                }

                // If complete, save and redirect
                if (data.complete && data.cvData) {
                    generatedCVData = data.cvData;
                    await saveCVData(data.cvData);
                }

            } catch (e) {
                console.error(e);
                status.innerHTML = '<span style="color:#ef4444;">Error: ' + e.message + '</span>';
            }
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');

            if (role === 'ai') {
                messageDiv.style.cssText = 'background:rgba(59,130,246,0.1); border-left:3px solid #3b82f6; padding:1rem; border-radius:8px; color:white; line-height:1.6; white-space:pre-wrap;';
                messageDiv.innerHTML = `<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; color:#3b82f6; font-weight:600;"><i class="fas fa-robot"></i> Claude</div>${content.replace(/\n/g, '<br>')}`;
            } else {
                messageDiv.style.cssText = 'background:rgba(255,255,255,0.05); border-left:3px solid #94a3b8; padding:1rem; border-radius:8px; color:white; line-height:1.6; white-space:pre-wrap; margin-left:2rem;';
                messageDiv.innerHTML = `<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; color:#94a3b8; font-weight:600;"><i class="fas fa-user"></i> You</div>${content.replace(/\n/g, '<br>')}`;
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function saveCVData(cvData) {
            try {
                // Generate user ID
                const userId = cvData.profile.name.split(' ')[0].toLowerCase() + Math.floor(Math.random() * 1000);
                const userDir = `cv-content/${userId}`;

                // Save all files
                await Promise.all([
                    fetch(`http://localhost:3000/api/save/${userId}/profile.json`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cvData.profile)
                    }),
                    fetch(`http://localhost:3000/api/save/${userId}/summary.json`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cvData.summary)
                    }),
                    fetch(`http://localhost:3000/api/save/${userId}/journey.json`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cvData.journey)
                    }),
                    fetch(`http://localhost:3000/api/save/${userId}/skills.json`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cvData.skills)
                    }),
                    fetch(`http://localhost:3000/api/save/${userId}/education.json`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cvData.education)
                    }),
                    fetch(`http://localhost:3000/api/save/${userId}/highlights.json`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cvData.highlights)
                    })
                ]);

                // Update users.json via backend
                const usersRes = await fetch('cv-content/users.json');
                let users = [];
                try {
                    users = await usersRes.json();
                } catch (e) {
                    users = [];
                }

                users.push({
                    id: userId,
                    name: cvData.profile.name,
                    title: cvData.profile.taglines[0] || 'Professional',
                    avatar: 'profile_pic.jpg'
                });

                // Save updated users list
                await fetch(`http://localhost:3000/api/save-users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(users)
                });

                // Redirect to resume
                setTimeout(() => {
                    window.location.href = `resume.html?user=${userId}`;
                }, 2000);

            } catch (e) {
                console.error('Save error:', e);
                alert('Failed to save CV data');
            }
        }

        loadProfiles();
    </script>
</body>

</html>